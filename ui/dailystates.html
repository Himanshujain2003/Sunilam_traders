<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Business Report - Sunilam Traders</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.10.5/font/bootstrap-icons.min.css">

  <style>
    body {
      background-color: #f8f9fa;
      background-image: url("/assets/backk.png");
      font-family: Arial, sans-serif;
      color: #333;
      background-size: cover;
    }
    .container { 
      margin-top: 30px;
      max-width: 1200px;
      padding: 20px;
      background: rgba(142,126,126); 
      border-radius:15px; 
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      height: auto;
      margin-left: 80px;
    }
    table th, table td {
      vertical-align: middle;
      text-align: center;
      padding: 8px;
      font-size: 14px;
      border: 1px solid #dee2e6;
    }
    .no-data {
      text-align: center;
      padding: 20px;
      color: red;
      font-weight: bold;
      font-size: 16px;
    }
    .header-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding: 10px;
      background: rgba(17, 16, 16, 0.64);
      border-radius: 10px;
      color: white;
    }
    .btn {
      margin: 0 5px;
      padding: 10px 15px;
      font-size: 14px;
      border-radius: 5px;
      color: white;
      background-color: #34495e;
      border: none;
    }
    .btn:hover {
      background: #34495e;
            color: #e8e7e5;
    }
    .imglogo {
      width: 160px;
      height: 120px;
      border-radius: 50%;
      position: fixed;
      top: 1rem;
      right: 1rem;
    }
    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
      margin-top: 20px;
    }
    .pagination button {
      border: none;
      background: #ddd;
      padding: 5px 10px;
      font-size: 16px;
      border-radius: 5px;
    }
    .pagination button.active {
      background: #f0eeed;
      color: black;
    }
    .stats-card {
      margin-top: 20px;
      background: #fff3cd;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .stats-card h5 {
      margin-bottom: 15px;
      color: #0e0d0d;
    } 
    .bi-bar-chart-fill {
      color: #121212;
      background-color: rgb(142, 126, 126);
      font-size: xx-large;
      padding: 5px;
      border-radius: 50%;
    }
    .btn-success {
       margin: 0 5px;
      padding: 10px 15px;
      font-size: 14px;
      border-radius: 5px;
      color:white;
      background-color: #34495e;
      border: none;
    }
    .btn-success:hover {
      background: #34495e;
            color: #e8e7e5;
    }
    .flex-grow-1 {
      flex-grow: 1;
      text-align: center;
      font-size: 1.5rm
    }
    .header-actions h2 {
      margin: 0;
      font-size: 1.5rem;
      color: #fff;
      flex-grow: 1;
    }
  </style>
</head>
<body>

<div class="container">
  <img src="/assets/logo.png" class="imglogo" alt="Sunilam Traders Logo">

  <div class="header-actions mb-4">
    <a href="home.html" class="btn btn-outline-secondary"><i class="bi bi-arrow-left"></i> Back</a>
    <h2 class="text-center flex-grow-1">Daily Business Report</h2>
    <button class="btn btn-success" onclick="exportPDF()">Today's Data as PDF</button>
  </div>

  <table id="businessTable" class="table table-striped table-bordered">
    <thead class="table-dark">
      <tr>
        <th>Product Name</th>
        <th>Quantity</th>
        <th>Unit</th>
        <th>Price per Unit</th>
        <th>Customer Name</th>
        <th>Amount</th>
        <th>Transaction Type</th>
        <th>Entry Date</th>
        <th>Entry By</th>
      </tr>
    </thead>
    <tbody>
      <tr><td colspan="9" class="no-data">Loading data...</td></tr>
    </tbody>
  </table>

  <nav>
    <ul id="pagination" class="pagination"></ul>
  </nav>
<div class="stats-card d-flex justify-content-between align-items-center">
  <div>
    <h5><i class="bi bi-bar-chart-fill"></i> Today's Business Summary</h5>
    <p><strong>Total Sales:</strong> ₹<span id="totalSales">0</span></p>
    <p><strong>Total Purchases:</strong> ₹<span id="totalPurchases">0</span></p>
    <p><strong>Business:</strong> ₹<span id="profit">0</span></p>
  </div>

  <!-- Report Button Right Side -->
  <div>
    <a href="report.html" class="btn btn-primary">Report</a>
  </div>
</div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<script>
const API_URL = "http://127.0.0.1:5000/api/stock/business";
let fullBusinessData = [];
let currentPage = 1;
const rowsPerPage = 5;

function normalizeDate(dateint) {
  if (!dateint) return "";
  return dateint.split(" ")[0].split("T")[0];
}

function fetchBusinessData() {
  fetch(API_URL)
    .then(response => response.json())
    .then(data => {
      fullBusinessData = Array.isArray(data) ? data : [];
      currentPage = 1;
      updateTableAndPagination();
      calculateStats();
    })
    .catch(err => {
      document.querySelector("#businessTable tbody").innerHTML =
        `<tr><td colspan="9" class="text-center text-danger">Error loading business data.</td></tr>`;
      document.getElementById("pagination").innerHTML = "";
      console.error(err);
    });
}

function updateTableAndPagination() {
  const tableBody = document.querySelector("#businessTable tbody");
  tableBody.innerHTML = "";

  if (fullBusinessData.length === 0) {
    tableBody.innerHTML = `<tr><td colspan="9" class="no-data">No business data available for today.</td></tr>`;
    document.getElementById("pagination").innerHTML = "";
    return;
  }

  const startIndex = (currentPage - 1) * rowsPerPage;
  const paginatedData = fullBusinessData.slice(startIndex, startIndex + rowsPerPage);

  paginatedData.forEach(row => {
    tableBody.innerHTML += `
      <tr>
        <td>${row.product_name || ""}</td>
        <td>${row.quantity || ""}</td>
        <td>${row.unit_name || ""}</td>
        <td>${row.price_per_unit || ""}</td>
        <td>${row.customer_name || ""}</td>
        <td>${row.amount || ""}</td>
        <td>${row.transaction_type || ""}</td>
        <td>${normalizeDate(row.entry_datetime) || ""}</td>
        <td>${row.entry_by || ""}</td>
      </tr>
    `;
  });

  updatePagination();
}

function updatePagination() {
  const totalPages = Math.ceil(fullBusinessData.length / rowsPerPage);
  const paginationElement = document.getElementById("pagination");
  paginationElement.innerHTML = "";

  if (totalPages <= 1) return;

  // Prev Arrow
  const prevBtn = document.createElement("li");
  prevBtn.innerHTML = `<button ${currentPage === 1 ? "disabled" : ""} onclick="changePage(${currentPage - 1})">&lt;</button>`;
  paginationElement.appendChild(prevBtn);

  // Page Number
  const pageBtn = document.createElement("li");
  pageBtn.innerHTML = `<button class="active">${currentPage}</button>`;
  paginationElement.appendChild(pageBtn);

  // Next Arrow
  const nextBtn = document.createElement("li");
  nextBtn.innerHTML = `<button ${currentPage === totalPages ? "disabled" : ""} onclick="changePage(${currentPage + 1})">&gt;</button>`;
  paginationElement.appendChild(nextBtn);
}

function changePage(page) {
  if (page < 1 || page > Math.ceil(fullBusinessData.length / rowsPerPage)) {
    return;
  }
  currentPage = page;
  updateTableAndPagination();
}

function calculateStats() {
  let totalSales = 0;
  let totalPurchases = 0;

  fullBusinessData.forEach(row => {
    const amount = parseFloat(row.amount) || 0;
    if (row.transaction_type && row.transaction_type.toLowerCase() === "sell") {
      totalSales += amount;
    } else if (row.transaction_type && row.transaction_type.toLowerCase() === "buy") {
      totalPurchases += amount;
    }
  });

  document.getElementById("totalSales").textContent = totalSales.toFixed(2);
  document.getElementById("totalPurchases").textContent = totalPurchases.toFixed(2);
  document.getElementById("profit").textContent = (totalSales - totalPurchases).toFixed(2);
}

function exportPDF() {
  if (fullBusinessData.length === 0) {
    alert("No data available for today to export.");
    return;
  }

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  doc.text("Business Report (Today)", 14, 10);
  doc.autoTable({
    startY: 20,
    head: [['Product Name', 'Quantity', 'Unit', 'Price per Unit', 'Customer Name', 'Amount', 'Transaction Type', 'Entry Date', 'Entry By']],
    body: fullBusinessData.map(row => [
      row.product_name || "",
      row.quantity || "",
      row.unit_name || "",
      row.price_per_unit || "",
      row.customer_name || "",
      row.amount || "",
      row.transaction_type || "",
      normalizeDate(row.entry_datetime) || "",
      row.entry_by || ""
    ])
  });

  doc.save(`Business_Report_${new Date().toISOString().split('T')[0]}.pdf`);
}

document.addEventListener("DOMContentLoaded", fetchBusinessData);
</script>
</body>
</html>
