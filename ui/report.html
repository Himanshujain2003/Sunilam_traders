<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Most Selling Products – Weekly & Monthly</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    
    :root {
      --bg: #f6f7fb;
      --card: #ffffff;
      --ink: #222;
      --muted: #6b7280;
      --brand: #34495e;
      --brand-2: #34495e;
      --ring: rgba(52, 73, 94, 0.35);
      --radius: 16px;
    }
    body {
      overflow: hidden;
      background-color: #f8f9fa;
      background-image: url("/assets/backk.png");
      font-family: Arial, sans-serif;
      color: #333;
      background-size: cover;
      margin: 0;
    }
    .wrap {

        max-width: 900px;
        margin: 28px auto;
        padding: 20px;
        background: rgba(142,126,126,0.9);
        border-radius: 15px;
        box-shadow: 0 6px 8px rgba(0, 0, 0, 0.1);
    }
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      background: #0f172a;
      color: #fff;
      padding: 14px 18px;
      border-radius: var(--radius);
      box-shadow: 0 6px 24px rgba(2,6,23,.16);
    }
    .header h1 {
      margin: 0;
      font-size: clamp(1.05rem, 2.2vw, 1.4rem);
      font-weight: 700;
      letter-spacing: .2px;
      flex-grow: 1;
      text-align: center;
    }
    .controls { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
    .btn {
      appearance: none;
      border: 1px solid transparent;
      background: #34495e;
      color: #fff;
      padding: 8px 12px;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      transition: .2s ease;
      text-decoration: none;
    }
    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(0,0,0,.08);
      background: #2c3e50;
    }
    .card {
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: 0 10px 28px rgba(2,6,23,.08);
      padding: 16px;
    }
    .grid { display: grid; gap: 16px; grid-template-columns: 1fr; margin-top: 16px; }
    @media (min-width: 640px) {
      .grid { grid-template-columns: repeat(2, 1fr); }
    }
    .section-title {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    .title { font-size: 1rem; font-weight: 800; }
    .muted { color: var(--muted); font-size: .9rem; }
    .seg {
      display: inline-flex;
      gap: 6px;
      background: #eef2ff;
      border: 1px solid #dbeafe;
      border-radius: 12px;
      padding: 4px;
    }
    .seg button {
      border: 0;
      background: transparent;
      padding: 8px 12px;
      border-radius: 8px;
      font-weight: 700;
      color: #1e293b;
      cursor: pointer;
    }
    .seg button.active {
      background: var(--brand);
      color: #fff;
      box-shadow: 0 0 0 3px var(--ring);
    }
    .table-wrap { overflow: auto; border-radius: 12px; border: 1px solid #e5e7eb; }
    table { width: 100%; border-collapse: collapse; background: #fff; }
    thead th {
      background: #f3f4f6;
      font-weight: 800;
      text-align: left;
      padding: 10px 12px;
      font-size: .9rem;
      color: #111827;
    }
    tbody td { border-top: 1px solid #f1f5f9; padding: 10px 12px; }
    .badge { display: inline-block; padding: 4px 8px; border-radius: 999px; background: #f1f5f9; font-weight: 700; font-size: .8rem; }
    .right { text-align: right; }
    .empty { text-align: center; color: var(--muted); padding: 20px; }
    .notice {
      padding: 10px 12px;
      background: #fff7ed;
      border: 1px solid #ffedd5;
      color: #9a3412;
      border-radius: 10px;
    }
    .imglogo {
      width: 160px;
      height: 120px;
      border-radius: 50%;
      position: fixed;
      top: 1rem;
      right: 1rem;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
  </style>
</head>

<body>
  <img src="/assets/logo.png" alt="Logo" class="imglogo" />

  <div class="wrap">
    <div class="header">
      <a href="home.html" class="btn">← Back</a>
      <h1>Most Selling Products</h1>
      <div class="controls">
        <div class="seg">
          <button id="btnWeek" class="active">This Week</button>
          <button id="btnMonth">This Month</button>
        </div>
        
        <input type="date" id="startDate" class="btn" style="color-scheme: dark;" title="Start Date">
        <input type="date" id="endDate" class="btn" style="color-scheme: dark;" title="End Date">
        <button id="btnApply" class="btn">Apply</button>
        <button id="btnExport" class="btn" style="margin-left:8px;">Export CSV</button>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="section-title">
          <div>
            <div class="title" id="chartTitle">Weekly Product Share (%)</div>
            <div class="muted" id="rangeText">Last 7 days</div>
          </div>
          <div class="muted" id="totalText">Total Qty: 0</div>
        </div>
        <div class="muted" id="totalQtyText">Total Qty: 0</div>
        <canvas id="pieCanvas" height="280"></canvas>
        <div id="emptyChart" class="empty" style="display:none;">No data found.</div>
      </div>

      <div class="card">
        <div class="section-title">
          <div class="title">Sold Products</div>
          <span class="muted">(sorted by quantity)</span>
        </div>
        <input type="text" id="searchInput" class="btn" placeholder="Search product..." style="margin-bottom:8px;">
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>Product</th>
                <th class="right">Qty</th>
                <th class="right">Amount</th>
              </tr>
            </thead>
            <tbody id="rows">
              <tr><td colspan="4" class="empty">Loading…</td></tr>
            </tbody>
          </table>
        </div>
        <div id="pagination" style="display:flex;gap:8px;justify-content:center;margin:16px 0;"></div>
        <div class="notice" style="margin-top:12px;">
          Tip: Use the switch above to toggle between <b>This Week</b> and <b>This Month</b>.
        </div>
      </div>
    </div>
  </div>

  <script>
    // --- CONFIGURATION & DOM ELEMENTS ---
    const API_URL = "http://127.0.0.1:5000/api/stocks/report"; 
    let chartRef = null;
    const COLORS = [
      '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40',
      '#16a34a', '#1f6feb', '#e67e22', '#2ecc71', '#e74c3c', '#8e44ad'
    ];

    const btnWeek = document.getElementById('btnWeek');
    const btnMonth = document.getElementById('btnMonth');
    const btnApply = document.getElementById('btnApply');
    const btnExport = document.getElementById('btnExport');
    const startDateInput = document.getElementById('startDate');
    const endDateInput = document.getElementById('endDate');
    const rowsEl = document.getElementById('rows');
    const totalText = document.getElementById('totalText');
    const chartTitle = document.getElementById('chartTitle');
    const rangeText = document.getElementById('rangeText');
    const pieCanvas = document.getElementById('pieCanvas');
    const emptyChart = document.getElementById('emptyChart');
    const totalQtyText = document.getElementById('totalQtyText');
    const searchInput = document.getElementById('searchInput');
    searchInput.addEventListener('input', () => {
      reloadCurrent();
    });
    
    // --- UI FUNCTIONS ---

    /**
     * Clears the date input fields.
     */
    function clearDateInputs() {
      startDateInput.value = '';
      endDateInput.value = '';
    }

    /**
     * Updates UI to reflect the active filter type (week, month, or custom).
     * @param {'week' | 'month' | 'custom'} type The type of filter being applied.
     */
    function setActive(type) {
      btnWeek.classList.toggle('active', type === 'week');
      btnMonth.classList.toggle('active', type === 'month');

      if (type === 'week') {
        chartTitle.textContent = 'Weekly Product Sales Amount';
        rangeText.textContent = 'Last 7 days';
        clearDateInputs();
      } else if (type === 'month') {
        chartTitle.textContent = 'Monthly Product Sales Amount';
        rangeText.textContent = 'Current month';
        clearDateInputs();
      }
      // For 'custom', the title and range text are set in the event listener.
    }

    /**
     * Builds or updates the doughnut chart with new data.
     * @param {string[]} labels - The labels for the chart segments.
     * @param {number[]} data - The data points for the chart.
     */
    function buildChart(labels, data) {
      if (chartRef) { chartRef.destroy(); }

      const hasData = labels && labels.length > 0;
      pieCanvas.style.display = hasData ? 'block' : 'none';
      emptyChart.style.display = hasData ? 'none' : 'block';

      if (!hasData) return;

      chartRef = new Chart(pieCanvas.getContext('2d'), {
        type: 'doughnut',
        data: {
          labels,
          datasets: [{
            data,
            backgroundColor: COLORS,
            borderWidth: 0,
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { position: 'bottom', labels: { padding: 20 } } },
          cutout: '58%'
        }
      });
    }

    /**
     * Populates the top products table with data.
     * @param {object[]} items - The list of product data.
     */
    function renderTable(items) {
      const searchTerm = (searchInput.value || '').toLowerCase();
      rowsEl.innerHTML = '';
      const filtered = items.filter(r => r.product_name.toLowerCase().includes(searchTerm));
      if (!filtered.length) {
        rowsEl.innerHTML = '<tr><td colspan="4" class="empty">No products found for this period.</td></tr>';
        return;
      }
      filtered.forEach((r, i) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><span class="badge">${i + 1}</span></td>
          <td>${r.product_name ?? '—'}</td>
          <td class="right">${Number(r.total_quantity || 0)}</td>
          <td class="right">₹${Number(r.total_amount || 0).toFixed(2)}</td>
        `;
        rowsEl.appendChild(tr);
      });
    }

    let currentPage = 1;
    const pageSize = 5;
    const paginationEl = document.getElementById('pagination');

    function renderPagination(totalCount, page, pageSize) {
      const totalPages = Math.ceil(totalCount / pageSize);
      paginationEl.innerHTML = '';

      if (totalPages <= 1) {
        paginationEl.style.display = 'none';
        return;
      }
      paginationEl.style.display = 'flex';

      const prevBtn = document.createElement('button');
      prevBtn.textContent = 'Prev';
      prevBtn.className = 'btn';
      prevBtn.disabled = page <= 1;
      prevBtn.onclick = () => {
        if (page > 1) {
          currentPage--;
          reloadCurrent();
        }
      };
      paginationEl.appendChild(prevBtn);

      for (let i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || Math.abs(i - page) <= 2) {
          const pageBtn = document.createElement('button');
          pageBtn.textContent = i;
          pageBtn.className = 'btn' + (i === page ? ' active' : '');
          pageBtn.onclick = () => {
            currentPage = i;
            reloadCurrent();
          };
          paginationEl.appendChild(pageBtn);
        } else if (i === page - 3 || i === page + 3) {
          const dots = document.createElement('span');
          dots.textContent = '...';
          dots.style.padding = '0 6px';
          paginationEl.appendChild(dots);
        }
      }

      const nextBtn = document.createElement('button');
      nextBtn.textContent = 'Next';
      nextBtn.className = 'btn';
      nextBtn.disabled = page >= totalPages;
      nextBtn.onclick = () => {
        if (page < totalPages) {
          currentPage++;
          reloadCurrent();
        }
      };
      paginationEl.appendChild(nextBtn);
    }

    function reloadCurrent() {
      // Determine current filter
      if (btnWeek.classList.contains('active')) {
        loadData({ type: 'week', page: currentPage, page_size: pageSize });
      } else if (btnMonth.classList.contains('active')) {
        loadData({ type: 'month', page: currentPage, page_size: pageSize });
      } else if (startDateInput.value && endDateInput.value) {
        loadData({ start_date: startDateInput.value, end_date: endDateInput.value, page: currentPage, page_size: pageSize });
      } else {
        loadData({ type: 'week', page: currentPage, page_size: pageSize });
      }
    }

    /**
     * Fetches report data from the API and updates the entire UI.
     * @param {object} params - The query parameters for the API call (e.g., {type: 'week'}).
     */
    async function loadData(params) {
      rowsEl.innerHTML = '<tr><td colspan="4" class="empty">Loading…</td></tr>';
      totalText.textContent = 'Total Amount: …';
      buildChart([], []);
      paginationEl.innerHTML = '';

      params.page = params.page || currentPage;
      params.page_size = params.page_size || pageSize;

      const query = new URLSearchParams(params).toString();
      const url = `${API_URL}?${query}`;

      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error(`Failed to fetch: ${res.statusText}`);
        const result = await res.json();
        const data = result.items || [];
        const totalAmount = data.reduce((sum, item) => sum + Number(item.total_amount || 0), 0);
        const totalQty = data.reduce((sum, item) => sum + Number(item.total_quantity || 0), 0);
        totalQtyText.textContent = `Total Qty: ${totalQty}`;
        totalText.textContent = `Total Amount: ₹${totalAmount.toFixed(2)}`;

        const labels = data.map(item => item.product_name || 'Unknown');
        const amounts = data.map(item => Number(item.total_amount || 0));

        buildChart(labels, amounts);
        renderTable(data);
        renderPagination(result.total_count, result.page, result.page_size);
      } catch (e) {
        console.error(e);
        rowsEl.innerHTML = '<tr><td colspan="4" class="empty">Failed to load data</td></tr>';
        buildChart([], []);
        totalText.textContent = 'Total Amount: 0';
        paginationEl.innerHTML = '';
      }
    }

    // --- EVENT LISTENERS & INITIALIZATION ---

    btnWeek.addEventListener('click', () => {
      currentPage = 1;
      setActive('week');
      loadData({ type: 'week', page: currentPage, page_size: pageSize });
    });

    btnMonth.addEventListener('click', () => {
      currentPage = 1;
      setActive('month');
      loadData({ type: 'month', page: currentPage, page_size: pageSize });
    });

    btnApply.addEventListener('click', () => {
      const startDate = startDateInput.value;
      const endDate = endDateInput.value;
      if (startDate && endDate) {
        if (new Date(startDate) > new Date(endDate)) {
          alert('Start date cannot be after the end date.');
          return;
        }
        currentPage = 1;
        setActive('custom');
        chartTitle.textContent = 'Custom Range Product Sales Amount';
        rangeText.textContent = `From ${startDate} to ${endDate}`;
        loadData({ start_date: startDate, end_date: endDate, page: currentPage, page_size: pageSize });
      } else if (startDate || endDate) {
        alert('Please select both a start and end date for the custom range.');
      } else {
        const activeType = btnWeek.classList.contains('active') ? 'week' : 'month';
        loadData({ type: activeType, page: currentPage, page_size: pageSize });
      }
    });

    // Deactivate preset buttons when a date is picked to improve UX
    [startDateInput, endDateInput].forEach(input => input.addEventListener('input', () => {
        if(startDateInput.value || endDateInput.value) setActive('custom');
    }));

    btnExport.addEventListener('click', () => {
      // Export current table data to CSV
      let csv = 'Product,Quantity,Amount\n';
      Array.from(rowsEl.children).forEach(tr => {
        const tds = tr.querySelectorAll('td');
        if (tds.length === 4 && !tr.classList.contains('empty')) {
          csv += `${tds[1].textContent},${tds[2].textContent},${tds[3].textContent.replace('₹','')}\n`;
        }
      });
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'sales_report.csv';
      a.click();
      URL.revokeObjectURL(url);
    });

    setActive('week');
    loadData({ type: 'week' });
  </script>
</body>
</html>
