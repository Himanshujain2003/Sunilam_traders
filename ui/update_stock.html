<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Sunilam Traders: shop everything</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/css/bootstrap.min.css">
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; /* Prevent scrolling */
            font-family: Arial, sans-serif;
            background: url('/assets/backk.png') no-repeat center center fixed;
            background-size: cover;
        }
        .form-container {
            background: rgb(142, 126, 126);
            max-width: 500px;
            margin: 60px auto;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.18);
        }
        .form-title
        {
            text-align: center;
            margin-bottom: 25px;
            font-weight: xx-bold;
            font-size: 2rem;
            font-family: 'Arial', sans-serif;
            color: #090909;
        }
        .back-btn {
            margin-bottom: 20px;
            font-size: 16px;
            padding: 8px 18px;
            border-radius: 6px;
            background: #34495e;
            color: #fff;
            border: none;
            cursor: pointer;
            display: block;
        }
        .back-btn:hover {
            background: #2c3e50;
            color: white;
        }
        .form-title {
            text-align: center;
            margin-bottom: 25px;
            font-weight: bold;
            font-size: 1.5rem;
            color: #34495e;
        }
        #message {
            margin-top: 15px;
            text-align: center;
        }
        .imglogo {
            width: 160px;
            height: 120px;
            border-radius: 50%;
            position: fixed;
            top: 1rem;
            right: 1rem;
        }
        .btn-primary {
            background-color:#34495e;
            border-color: #34495e;
            transition: background-color 0.2s, border-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #2c3e50;
            border-color: #2c3e50;
        }
    </style>
</head>
<body>
    <div class="form-container">
        <img src="/assets/logo.png" class="imglogo" alt="Sunilam Traders Logo">
        <button class="back-btn" id="backBtn">&larr; Back</button>
        <div class="form-title">Update Stock</div>
        <form id="updateStockForm">
            <div class="mb-3">
                <label for="product_name" class="form-label">Product Name:</label>
                <input type="text" id="product_name" name="product_name" class="form-control" required>
            </div>
            <div class="mb-3">
                <label for="quantity" class="form-label">Quantity:</label>
                <input type="number" id="quantity" name="quantity" class="form-control" required min="0">
            </div>
            <div class="mb-3">
                <label for="unit_id" class="form-label">Unit*:</label>
                <!-- This dropdown will be populated dynamically -->
                <select id="unit_id" name="unit_id" class="form-control" required></select>
                
            </div>
            <div class="mb-3">
                <label for="price_per_unit" class="form-label">Price per Unit:</label>
                <input type="number" id="price_per_unit" name="price_per_unit" class="form-control" required min="0" step="0.01">
            </div>
            <button type="submit" class="btn btn-primary w-100">Update Stock</button>
        </form>
        <div id="message"></div>
    </div>

    <script>
        const msgDiv = document.getElementById('message');
        const stockId = new URLSearchParams(window.location.search).get('id');

        document.getElementById('backBtn').onclick = function() {
            window.location.href = 'stocks.html';
        };

        if (!stockId) {
            msgDiv.innerHTML = '<span class="text-danger">No stock ID provided.</span>';
            document.getElementById('updateStockForm').style.display = 'none';
        } else {
            // Use async/await for cleaner, more readable code
            async function loadPageData() {
                try {
                    // Step 1: Fetch all available units from the dedicated API endpoint
                    const unitsResponse = await fetch('http://127.0.0.1:5000/api/units');
                    if (!unitsResponse.ok) throw new Error('Failed to load units.');
                    const units = await unitsResponse.json();

                    // Populate the unit dropdown with all possible units
                    const unitDropdown = document.getElementById('unit_id');
                    unitDropdown.innerHTML = '<option value="">Select Unit</option>'; // Default option
                    units.forEach(unit => {
                        const option = document.createElement('option');
                        option.value = unit.id;
                        option.textContent = unit.unit_name;
                        unitDropdown.appendChild(option);
                    });

                    // Step 2: Fetch all stocks to find the specific one to edit
                    // Note: A more efficient approach would be a dedicated API endpoint to get a single stock by ID.
                    const stocksResponse = await fetch('http://127.0.0.1:5000/api/stocks');
                    if (!stocksResponse.ok) throw new Error(`Could not fetch stock data (Status: ${stocksResponse.status})`);
                    const stocks = await stocksResponse.json();

                    const stock = stocks.find(s => s.id == stockId);
                    if (!stock) {
                        throw new Error(`Stock with ID ${stockId} not found.`);
                    }

                    // Step 3: Pre-fill the form with the stock's data
                    document.getElementById('product_name').value = stock.product_name;
                    document.getElementById('quantity').value = stock.quantity;
                    document.getElementById('unit_id').value = stock.unit_id; // Set the selected unit by its ID
                    document.getElementById('price_per_unit').value = stock.price_per_unit;

                } catch (err) {
                    msgDiv.innerHTML = `<span class="text-danger">Error: ${err.message}</span>`;
                    document.getElementById('updateStockForm').style.display = 'none';
                }
            }

            loadPageData();

            document.getElementById('updateStockForm').addEventListener('submit', function (e) {
                e.preventDefault();
                msgDiv.innerHTML = '';
                const updatedData = {
                    product_name: document.getElementById('product_name').value,
                    quantity: parseInt(document.getElementById('quantity').value),
                    unit_id: parseInt(document.getElementById('unit_id').value), // Send unit_id
                    price_per_unit: parseFloat(document.getElementById('price_per_unit').value)
                };

                fetch(`http://127.0.0.1:5000/api/stocks/${stockId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updatedData)
                })
                .then(async response => {
                    if (!response.ok) {
                        // The server returned an error. Try to get a meaningful message.
                        const contentType = response.headers.get("content-type");
                        let errorMsg = `Update failed with status: ${response.status}`;
                        if (contentType && contentType.includes("application/json")) {
                            const errData = await response.json();
                            errorMsg = errData.error || JSON.stringify(errData);
                        } else {
                            errorMsg += ". The server had an internal error. While the data might have been updated, the server failed to send a success response.";
                        }
                        throw new Error(errorMsg);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.message) {
                        msgDiv.innerHTML = `<span class="text-success">${data.message} Redirecting...</span>`;
                        setTimeout(() => window.location.href = 'stocks.html', 2000);
                    } else {
                        msgDiv.innerHTML = `<span class="text-danger">${data.error || 'Update failed.'}</span>`;
                    }
                })
                .catch(error => {
                    msgDiv.innerHTML = `<span class="text-danger">Error: ${error.message}</span>`;
                });
            });
        }
    </script>
</body>
</html>
